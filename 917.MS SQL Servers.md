# MS SQL Intro and Recon

Microsoft SQL Server is a relational database management system commonly found in Windows environments. Theyâ€™re typically used to store information to support a myriad of business functions. In addition to the obvious data theft opportunities, they also have a large attack surface, allowing code execution, privilege escalation, lateral movement and persistence.
PowerUpSQL and SQLRecon are excellent tools for enumerating and interacting with MS SQL Servers.
PowerUpSQL has a few cmdlets available for finding MS SQL Servers, including Get-SQLInstanceDomain, Get-SQLInstanceBroadcast and Get-SQLInstanceScanUDP.

    powershell-import C:\Tools\PowerUpSQL\PowerUpSQL.ps1
    
    powershell Get-SQLInstanceDomain

Get-SQLInstanceDomain works by searching for SPNs that begin with MSSQL*.  This output shows that SQL-2 is running an instance of MS SQL server, under the context of the mssql_svc domain account.  You may also search the domain for groups that sound like they may have access to database instances (for example, a "SQL Admins" group).
Get-SQLConnectionTest can be used to test whether or not we can connect to the database.

    powershell Get-SQLConnectionTest -Instance "sql-2.dev.cyberbotic.io,1433" | fl

Then use Get-SQLServerInfo to gather more information about the instance.

    powershell Get-SQLServerInfo -Instance "sql-2.dev.cyberbotic.io,1433"

If there are multiple SQL Servers available, you can chain these commands together to automate the data collection.

    powershell Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLServerInfo

SQLRecon can also enumerate servers via SPNs and fetch information about the instance with the info module.
    
    execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /enum:sqlspns

    execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth:wintoken /host:sql-2.dev.cyberbotic.io /module:info

The /auth:wintoken option allows SQLRecon to use the access token of the Beacon.  This output shows that whilst the database is accessible, our current user, bfarmer, is not a sysadmin.  SQLRecon has a nice module which can show us what roles we do have.

    execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:whoami

On default installations, standard users do not have this "public" role by default and must be explicitly granted through SQL Server Manager Studio (SSMS).  The aforementioned information on a SQL instance cannot be enumerated if the user's security context does not have a valid role.

Finding a user (or group) that does have access can be challenging, because without the ability to query the SQL instance to ask it, you can be stuck guessing.  One port of call is to look for appropriately named domain groups and their members.

    powershell Get-DomainGroup -Identity *SQL* | % { Get-DomainGroupMember -Identity $_.distinguishedname | select groupname, membername }

Another option is to go after the MS SQL service account itself as this is also often given sysadmin privileges.  This assumption is the basis of BloodHound's SQLAdmin attack path.  We know that the domain account being used to run the service is DEV\mssql_svc and that the account is kerberoastable owing to its SPN.  If we can crack its plaintext password, we can use it to gain access to the SQL instance.  The credentials can be used with make_token in Beacon and /a:WinToken in SQLRecon; or the /a:WinDomain option with /d:<domain> /u:<username> /p:<password> in SQLRecon directly.

    execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:windomain /d:dev.cyberbotic.io /u:mssql_svc /p:Cyberb0tic /h:sql-2.dev.cyberbotic.io,1433 /m:whoami

Once we have access, there are several options for issuing queries against a SQL instance.  Get-SQLQuery from PowerUpSQL:

    powershell Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "select @@servername"

SQLRecon:

    execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:query /c:"select @@servername"

mssqlclient.py from Impacket via proxychains:

    proxychains mssqlclient.py -windows-auth DEV/bfarmer@10.10.122.25

Or a Windows SQL GUI, such as HeidiSQL via Proxifier:

![image](https://github.com/user-attachments/assets/ce9bb14f-9363-4ffd-a904-05a9aadda094)














  
